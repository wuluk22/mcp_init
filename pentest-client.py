import requests
import json
import uuid

# Configuration
KALI_IP = "192.168.1.100"  # Change to your actual Kali IP
MCP_SERVER = f"http://{KALI_IP}:8000"
OLLAMA_URL = "http://localhost:11434/api/chat"

# Generate session ID
SESSION_ID = str(uuid.uuid4())

def test_connection():
    """Test connection to Kali MCP server"""
    try:
        response = requests.get(f"{MCP_SERVER}/health", timeout=5)
        return response.status_code == 200
    except:
        return False

def mcp_request(method, params=None):
    """Make an MCP request with session management"""
    payload = {
        "jsonrpc": "2.0",
        "id": str(uuid.uuid4()),
        "method": method
    }
    
    if params:
        payload["params"] = params
    
    headers = {
        "Content-Type": "application/json",
        "Mcp-Session-Id": SESSION_ID
    }
    
    try:
        response = requests.post(
            f"{MCP_SERVER}/mcp",
            json=payload,
            headers=headers,
            timeout=300
        )
        
        if response.status_code == 200:
            return response.json()
        else:
            print(f"HTTP Error {response.status_code}: {response.text}")
            return None
    except Exception as e:
        print(f"Request error: {e}")
        return None

def initialize_session():
    """Initialize MCP session"""
    return mcp_request("initialize", {
        "protocolVersion": "2024-11-05",
        "capabilities": {},
        "clientInfo": {
            "name": "pentest-client",
            "version": "1.0.0"
        }
    })

def list_mcp_tools():
    """Get available pentest tools from MCP server"""
    response = mcp_request("tools/list")
    if response and "result" in response:
        return response["result"].get("tools", [])
    return []

def call_mcp_tool(tool_name, arguments):
    """Execute a pentest tool on Kali"""
    response = mcp_request("tools/call", {
        "name": tool_name,
        "arguments": arguments
    })
    
    if response and "result" in response:
        return response["result"]
    return {"error": "Tool call failed"}

def format_tools_for_qwen(mcp_tools):
    """Convert MCP tool format to Ollama/Qwen format"""
    qwen_tools = []
    for tool in mcp_tools:
        qwen_tools.append({
            "type": "function",
            "function": {
                "name": tool['name'],
                "description": tool.get('description', ''),
                "parameters": tool.get('inputSchema', {})
            }
        })
    return qwen_tools

def chat_with_qwen(messages, tools):
    """Send request to local Qwen model"""
    payload = {
        "model": "qwen2.5:7b",
        "messages": messages,
        "stream": False
    }
    
    if tools:
        payload["tools"] = tools
    
    try:
        response = requests.post(OLLAMA_URL, json=payload, timeout=60)
        return response.json()
    except Exception as e:
        print(f"Error with Qwen: {e}")
        return {}

def main():
    print("üîß Pentest Assistant - Connecting to systems...")
    
    # Test Kali connection
    if not test_connection():
        print(f"‚ùå Cannot connect to Kali MCP server at {MCP_SERVER}")
        print("   Make sure:")
        print("   1. Kali VM is running")
        print("   2. MCP server is started: MCP_TRANSPORT=http pentest-mcp")
        print(f"   3. Kali IP is correct: {KALI_IP}")
        return
    
    print(f"‚úÖ Connected to Kali at {MCP_SERVER}")
    
    # Initialize MCP session
    init_response = initialize_session()
    if not init_response:
        print("‚ùå Failed to initialize MCP session")
        return
    
    print(f"‚úÖ MCP session initialized: {SESSION_ID[:8]}...")
    
    # Get available tools
    mcp_tools = list_mcp_tools()
    if not mcp_tools:
        print("‚ùå No tools available from MCP server")
        return
    
    print(f"‚úÖ Available tools ({len(mcp_tools)}):")
    for tool in mcp_tools:
        print(f"   - {tool['name']}: {tool.get('description', '')[:60]}...")
    
    # Check Ollama
    try:
        requests.get("http://localhost:11434", timeout=2)
        print("‚úÖ Ollama is running")
    except:
        print("‚ùå Ollama is not running. Start it with: ollama serve")
        return
    
    qwen_tools = format_tools_for_qwen(mcp_tools)
    messages = []
    
    print("\n" + "="*60)
    print("ü§ñ Pentest Assistant Ready (Qwen 2.5:7b + MCP Tools)")
    print("="*60)
    print("Type your pentesting requests or 'exit' to quit")
    print("Example: 'Scan 192.168.1.1 with nmap'")
    print()
    
    while True:
        try:
            user_input = input("You: ").strip()
            
            if user_input.lower() in ['exit', 'quit', 'q']:
                print("Goodbye!")
                break
            
            if not user_input:
                continue
            
            messages.append({"role": "user", "content": user_input})
            
            # Agentic loop
            max_iterations = 10
            for iteration in range(max_iterations):
                response = chat_with_qwen(messages, qwen_tools)
                
                if not response:
                    print("‚ùå No response from Qwen")
                    break
                
                assistant_msg = response.get('message', {})
                messages.append(assistant_msg)
                
                # Check if Qwen wants to use tools
                if 'tool_calls' in assistant_msg and assistant_msg['tool_calls']:
                    print(f"\nüî® Executing {len(assistant_msg['tool_calls'])} tool(s) on Kali...")
                    
                    for tool_call in assistant_msg['tool_calls']:
                        func = tool_call['function']
                        tool_name = func['name']
                        
                        # Parse arguments
                        if isinstance(func['arguments'], str):
                            tool_args = json.loads(func['arguments'])
                        else:
                            tool_args = func['arguments']
                        
                        print(f"\n  ‚Üí {tool_name}")
                        print(f"    Args: {json.dumps(tool_args, indent=6)}")
                        
                        # Execute on Kali
                        result = call_mcp_tool(tool_name, tool_args)
                        
                        print(f"    ‚úì Done")
                        
                        # Add result to conversation
                        messages.append({
                            "role": "tool",
                            "content": json.dumps(result, indent=2)
                        })
                    
                    # Continue loop to let Qwen process results
                    continue
                
                # No more tool calls, show final response
                if 'content' in assistant_msg and assistant_msg['content']:
                    print(f"\nü§ñ Assistant:\n{assistant_msg['content']}\n")
                break
            
            else:
                print("\n‚ö†Ô∏è Reached max iterations\n")
        
        except KeyboardInterrupt:
            print("\n\nGoodbye!")
            break
        except Exception as e:
            print(f"\n‚ùå Error: {e}\n")

if __name__ == "__main__":
    main()
