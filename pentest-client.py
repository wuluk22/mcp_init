import asyncio
import json
from mcp import ClientSession
from mcp.client.streamable_http import streamablehttp_client
import requests

# Configuration
KALI_IP = "192.168.1.100"  # Change to your actual Kali IP
MCP_SERVER_URL = f"http://{KALI_IP}:8000/mcp"
OLLAMA_URL = "http://localhost:11434/api/chat"

def test_basic_connection():
    """Test basic HTTP connection"""
    try:
        response = requests.get(f"http://{KALI_IP}:8000/health", timeout=5)
        return response.status_code == 200
    except:
        return False

def chat_with_qwen(messages, tools):
    """Send request to local Qwen model"""
    payload = {
        "model": "qwen2.5:7b",
        "messages": messages,
        "stream": False
    }
    
    if tools:
        payload["tools"] = tools
    
    try:
        response = requests.post(OLLAMA_URL, json=payload, timeout=60)
        return response.json()
    except Exception as e:
        print(f"Error with Qwen: {e}")
        return {}

def format_tools_for_qwen(mcp_tools):
    """Convert MCP tool format to Ollama/Qwen format"""
    qwen_tools = []
    for tool in mcp_tools:
        # MCP tools have .name, .description, and .inputSchema attributes
        tool_def = {
            "type": "function",
            "function": {
                "name": tool.name,
                "description": tool.description or "",
                "parameters": tool.inputSchema
            }
        }
        qwen_tools.append(tool_def)
    return qwen_tools

async def run_pentest_assistant():
    print("üîß Pentest Assistant - Connecting to systems...")
    
    # Test basic HTTP connection first
    if not test_basic_connection():
        print(f"‚ùå Cannot connect to Kali at http://{KALI_IP}:8000")
        print("   Make sure:")
        print("   1. Kali VM is running")
        print("   2. MCP server is started: MCP_TRANSPORT=http pentest-mcp")
        print(f"   3. Kali IP is correct: {KALI_IP}")
        return
    
    print(f"‚úÖ Basic connection to Kali successful")
    
    # Check Ollama
    try:
        requests.get("http://localhost:11434", timeout=2)
        print("‚úÖ Ollama is running")
    except:
        print("‚ùå Ollama is not running. Start it with: ollama serve")
        return
    
    print(f"\nüîå Connecting to MCP server via Streamable HTTP...")
    print(f"   URL: {MCP_SERVER_URL}\n")
    
    try:
        # Connect using the MCP streamable HTTP client
        # This returns (read_stream, write_stream, extra_info) tuple
        async with streamablehttp_client(MCP_SERVER_URL) as (read_stream, write_stream, _):
            # Create a client session with the streams
            async with ClientSession(read_stream, write_stream) as session:
                # Initialize the MCP session
                await session.initialize()
                print("‚úÖ MCP session initialized")
                
                # List available tools
                tools_response = await session.list_tools()
                mcp_tools = tools_response.tools
                
                if not mcp_tools:
                    print("‚ùå No tools available from MCP server")
                    return
                
                print(f"‚úÖ Available tools ({len(mcp_tools)}):")
                for tool in mcp_tools:
                    desc = tool.description[:60] if tool.description else "No description"
                    print(f"   - {tool.name}: {desc}...")
                
                qwen_tools = format_tools_for_qwen(mcp_tools)
                messages = []
                
                print("\n" + "="*60)
                print("ü§ñ Pentest Assistant Ready (Qwen 2.5:7b + MCP Tools)")
                print("="*60)
                print("Type your pentesting requests or 'exit' to quit")
                print("Example: 'Scan 192.168.1.1 with nmap'")
                print()
                
                while True:
                    try:
                        # Get user input (needs to be async)
                        user_input = await asyncio.to_thread(input, "You: ")
                        user_input = user_input.strip()
                        
                        if user_input.lower() in ['exit', 'quit', 'q']:
                            print("Goodbye!")
                            break
                        
                        if not user_input:
                            continue
                        
                        messages.append({"role": "user", "content": user_input})
                        
                        # Agentic loop
                        max_iterations = 10
                        for iteration in range(max_iterations):
                            # Call Qwen
                            response = await asyncio.to_thread(chat_with_qwen, messages, qwen_tools)
                            
                            if not response:
                                print("‚ùå No response from Qwen")
                                break
                            
                            assistant_msg = response.get('message', {})
                            messages.append(assistant_msg)
                            
                            # Check if Qwen wants to use tools
                            if 'tool_calls' in assistant_msg and assistant_msg['tool_calls']:
                                print(f"\nüî® Executing {len(assistant_msg['tool_calls'])} tool(s) on Kali...")
                                
                                for tool_call in assistant_msg['tool_calls']:
                                    func = tool_call['function']
                                    tool_name = func['name']
                                    
                                    # Parse arguments
                                    if isinstance(func['arguments'], str):
                                        tool_args = json.loads(func['arguments'])
                                    else:
                                        tool_args = func['arguments']
                                    
                                    print(f"\n  ‚Üí {tool_name}")
                                    print(f"    Args: {json.dumps(tool_args, indent=6)}")
                                    
                                    # Execute on Kali via MCP
                                    try:
                                        result = await session.call_tool(tool_name, tool_args)
                                        print(f"    ‚úì Done")
                                        
                                        # Extract content from result
                                        # MCP tool results have a .content attribute which is a list
                                        result_content = []
                                        for content_item in result.content:
                                            if hasattr(content_item, 'text'):
                                                result_content.append(content_item.text)
                                            else:
                                                result_content.append(str(content_item))
                                        
                                        result_text = "\n".join(result_content)
                                        
                                        # Add result to conversation
                                        messages.append({
                                            "role": "tool",
                                            "content": result_text
                                        })
                                    except Exception as e:
                                        print(f"    ‚úó Error: {e}")
                                        messages.append({
                                            "role": "tool",
                                            "content": json.dumps({"error": str(e)})
                                        })
                                
                                # Continue loop to let Qwen process results
                                continue
                            
                            # No more tool calls, show final response
                            if 'content' in assistant_msg and assistant_msg['content']:
                                print(f"\nü§ñ Assistant:\n{assistant_msg['content']}\n")
                            break
                        
                        else:
                            print("\n‚ö†Ô∏è Reached max iterations\n")
                    
                    except KeyboardInterrupt:
                        print("\n\nGoodbye!")
                        break
                    except Exception as e:
                        print(f"\n‚ùå Error: {e}\n")
                        import traceback
                        traceback.print_exc()
    
    except Exception as e:
        print(f"‚ùå Failed to connect to MCP server: {e}")
        print(f"   Error details:")
        import traceback
        traceback.print_exc()
        print(f"\n   Make sure the server is running with: MCP_TRANSPORT=http pentest-mcp")

def main():
    asyncio.run(run_pentest_assistant())

if __name__ == "__main__":
    main()
